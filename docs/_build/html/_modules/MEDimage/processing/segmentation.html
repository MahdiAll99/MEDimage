<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MEDimage.processing.segmentation &mdash; MEDimage  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MEDimage
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">MEDimage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../FAQs.html">FAQs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MEDimage</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>MEDimage.processing.segmentation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for MEDimage.processing.segmentation</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>


<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">MEDimage.MEDimage</span> <span class="kn">import</span> <span class="n">MEDimage</span>
<span class="kn">from</span> <span class="nn">nibabel</span> <span class="kn">import</span> <span class="n">Nifti1Image</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">center_of_mass</span>

<span class="kn">from</span> <span class="nn">..utils.image_volume_obj</span> <span class="kn">import</span> <span class="n">image_volume_obj</span>
<span class="kn">from</span> <span class="nn">..utils.imref</span> <span class="kn">import</span> <span class="n">imref3d</span><span class="p">,</span> <span class="n">intrinsicToWorld</span><span class="p">,</span> <span class="n">worldToIntrinsic</span>
<span class="kn">from</span> <span class="nn">..utils.inpolygon</span> <span class="kn">import</span> <span class="n">inpolygon</span>
<span class="kn">from</span> <span class="nn">..utils.interp3</span> <span class="kn">import</span> <span class="n">interp3</span>
<span class="kn">from</span> <span class="nn">..utils.mode</span> <span class="kn">import</span> <span class="n">mode</span>
<span class="kn">from</span> <span class="nn">..utils.parse_contour_string</span> <span class="kn">import</span> <span class="n">parse_contour_string</span>
<span class="kn">from</span> <span class="nn">..utils.strfind</span> <span class="kn">import</span> <span class="n">strfind</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_roi_from_indexes"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.get_roi_from_indexes">[docs]</a><span class="k">def</span> <span class="nf">get_roi_from_indexes</span><span class="p">(</span>
        <span class="n">MEDimg</span><span class="p">:</span> <span class="n">MEDimage</span><span class="p">,</span> 
        <span class="n">name_roi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">box_string</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">image_volume_obj</span><span class="p">,</span> <span class="n">image_volume_obj</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Extracts the ROI box (+ smallest box containing the region of interest)</span>
<span class="sd">    and associated mask from the indexes saved in &#39;MEDimage&#39; file.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        MEDimage (MEDimage): The MEDimage class object.</span>
<span class="sd">        name_roi (str): name of the ROI since the a volume can have multuiple</span>
<span class="sd">            ROIs.</span>
<span class="sd">        box_string (str): Specifies the size if the box containing the ROI</span>

<span class="sd">            - &#39;full&#39;: Full imaging data as output.</span>
<span class="sd">            - &#39;box&#39;: computes the smallest bounding box.</span>
<span class="sd">            - Ex: &#39;box10&#39;: 10 voxels in all three dimensions are added to \</span>
<span class="sd">                the smallest bounding box. The number after &#39;box&#39; defines the \</span>
<span class="sd">                number of voxels to add.</span>
<span class="sd">            - Ex: &#39;2box&#39;: Computes the smallest box and outputs double its \</span>
<span class="sd">                size. The number before &#39;box&#39; defines the multiplication in \</span>
<span class="sd">                size.</span>

<span class="sd">    Returns:</span>
<span class="sd">        2-element tuple containing</span>

<span class="sd">        - ndarray: vol_obj, 3D array of imaging data defining the smallest box \</span>
<span class="sd">            containing the region of interest.</span>
<span class="sd">        - ndarray: roi_obj, 3D array of 1&#39;s and 0&#39;s defining the ROI in ROIbox.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This takes care of the &quot;Volume resection&quot; step</span>
    <span class="c1"># as well using the argument &quot;box&quot;. No fourth</span>
    <span class="c1"># argument means &#39;interp&#39; by default.</span>

    <span class="c1"># PARSING OF ARGUMENTS</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">name_structure_set</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delimiters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;\+&quot;</span><span class="p">,</span> <span class="s2">&quot;\-&quot;</span><span class="p">]</span>
        <span class="n">n_contour_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">MEDimg</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">ROI</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span>

        <span class="n">name_roi</span><span class="p">,</span> <span class="n">vect_plus_minus</span> <span class="o">=</span> <span class="n">get_sep_roi_names</span><span class="p">(</span><span class="n">name_roi</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">)</span>
        <span class="n">contour_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name_roi</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">name_structure_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name_structure_set</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">name_structure_set</span><span class="p">:</span>
            <span class="n">name_structure_set</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_sep_roi_names</span><span class="p">(</span><span class="n">name_structure_set</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_roi</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_structure_set</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The numbers of defined ROI names and Structure Set names are not the same&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_roi</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_contour_data</span><span class="p">):</span>
                <span class="n">name_temp</span> <span class="o">=</span> <span class="n">MEDimg</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">ROI</span><span class="o">.</span><span class="n">get_roi_name</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name_temp</span> <span class="o">==</span> <span class="n">name_roi</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">name_structure_set</span><span class="p">:</span>
                        <span class="c1"># FOR DICOM + RTSTRUCT</span>
                        <span class="n">name_set_temp</span> <span class="o">=</span> <span class="n">MEDimg</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">ROI</span><span class="o">.</span><span class="n">get_name_set</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">name_set_temp</span> <span class="o">==</span> <span class="n">name_structure_set</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                            <span class="n">contour_number</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">contour_number</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="k">break</span>

        <span class="n">n_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">contour_number</span><span class="p">)</span>
        <span class="c1"># contour_string IS FOR EXAMPLE &#39;3&#39; or &#39;1-3+2&#39;</span>
        <span class="n">contour_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">contour_number</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_roi</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">vect_plus_minus</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
            <span class="k">elif</span> <span class="n">vect_plus_minus</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">contour_string</span> <span class="o">=</span> <span class="n">contour_string</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">+</span> \
                <span class="nb">str</span><span class="p">(</span><span class="n">contour_number</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">box_string</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span> <span class="ow">or</span> <span class="s2">&quot;box&quot;</span> <span class="ow">in</span> <span class="n">box_string</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The third argument must either be </span><span class="se">\&quot;</span><span class="s2">full</span><span class="se">\&quot;</span><span class="s2"> or contain the word </span><span class="se">\&quot;</span><span class="s2">box</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">contour_number</span><span class="p">,</span> <span class="n">operations</span> <span class="o">=</span> <span class="n">parse_contour_string</span><span class="p">(</span><span class="n">contour_string</span><span class="p">)</span>

        <span class="c1"># INTIALIZATIONS</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">contour_number</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">n_contour</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">contour_number</span> <span class="o">=</span> <span class="p">[</span><span class="n">contour_number</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_contour</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_number</span><span class="p">)</span>

        <span class="c1"># Note: sData is a nested dictionary not an object</span>
        <span class="n">spatial_ref</span> <span class="o">=</span> <span class="n">MEDimg</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">spatialRef</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">MEDimg</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># APPLYING OPERATIONS ON ALL MASKS</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">MEDimg</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_indexes_by_roi_name</span><span class="p">(</span><span class="n">name_roi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">n_contour</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">operations</span><span class="p">[</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
                <span class="n">roi</span> <span class="o">+=</span> <span class="n">MEDimg</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_indexes_by_roi_name</span><span class="p">(</span><span class="n">name_roi</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">operations</span><span class="p">[</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">roi</span> <span class="o">-=</span> <span class="n">MEDimg</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">get_indexes_by_roi_name</span><span class="p">(</span><span class="n">name_roi</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown operation on ROI.&quot;</span><span class="p">)</span>

            <span class="n">roi</span><span class="p">[</span><span class="n">roi</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">roi</span><span class="p">[</span><span class="n">roi</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># COMPUTING THE BOUNDING BOX</span>
        <span class="n">vol</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">new_spatial_ref</span> <span class="o">=</span> <span class="n">compute_box</span><span class="p">(</span><span class="n">vol</span><span class="o">=</span><span class="n">vol</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span>
                                            <span class="n">spatial_ref</span><span class="o">=</span><span class="n">spatial_ref</span><span class="p">,</span>
                                            <span class="n">box_string</span><span class="o">=</span><span class="n">box_string</span><span class="p">)</span>

        <span class="c1"># ARRANGE OUTPUT</span>
        <span class="n">vol_obj</span> <span class="o">=</span> <span class="n">image_volume_obj</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">vol</span><span class="p">,</span> <span class="n">spatial_ref</span><span class="o">=</span><span class="n">new_spatial_ref</span><span class="p">)</span>
        <span class="n">roi_obj</span> <span class="o">=</span> <span class="n">image_volume_obj</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span> <span class="n">spatial_ref</span><span class="o">=</span><span class="n">new_spatial_ref</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> PROBLEM WITH PRE-PROCESSING OF FEATURES IN get_roi_from_indexes():</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">MEDimg</span><span class="o">.</span><span class="n">radiomics</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{(</span><span class="s1">&#39;scale&#39;</span><span class="o">+</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">MEDimg</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">scale_non_text</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;dot&#39;</span><span class="p">)):</span> <span class="s1">&#39;ERROR_PROCESSING&#39;</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">vol_obj</span><span class="p">,</span> <span class="n">roi_obj</span></div>

<div class="viewcode-block" id="get_sep_roi_names"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.get_sep_roi_names">[docs]</a><span class="k">def</span> <span class="nf">get_sep_roi_names</span><span class="p">(</span><span class="n">name_roi_in</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">delimiters</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                                                 <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Seperated ROI names present in the given ROI name. An ROI name can</span>
<span class="sd">    have multiple ROI names seperated with curly brackets and delimeters.</span>
<span class="sd">    Note:</span>
<span class="sd">        Works only for delimiters &quot;+&quot; and &quot;-&quot;.</span>
<span class="sd">    Args:</span>
<span class="sd">        name_roi_in (str): Name of ROIs that will be extracted from the imagign volume. \</span>
<span class="sd">                           Separated with curly brackets and delimeters. Ex: &#39;{ED}+{ET}&#39;.</span>
<span class="sd">        delimiters (List): List of delimeters of &quot;+&quot; and &quot;-&quot;.</span>
<span class="sd">    Returns:</span>
<span class="sd">        2-element tuple containing </span>
<span class="sd">        </span>
<span class="sd">        - List[int]: List of ROI names seperated and excluding curly brackets.</span>
<span class="sd">        - ndarray: array of 1&#39;s and -1&#39;s that defines the regions that will \</span>
<span class="sd">                 included and/or excluded in/from the imaging data.</span>
<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; get_sep_roi_names(&#39;{ED}+{ET}&#39;, [&#39;+&#39;, &#39;-&#39;])</span>
<span class="sd">        [&#39;ED&#39;, &#39;ET&#39;], [1]</span>
<span class="sd">        &gt;&gt;&gt; get_sep_roi_names(&#39;{ED}-{ET}&#39;, [&#39;+&#39;, &#39;-&#39;])</span>
<span class="sd">        [&#39;ED&#39;, &#39;ET&#39;], [-1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># EX:</span>
    <span class="c1">#name_roi_in = &#39;{GTV-1}&#39;</span>
    <span class="c1">#delimiters = [&#39;\\+&#39;,&#39;\\-&#39;]</span>

    <span class="c1"># FINDING &quot;+&quot; and &quot;-&quot;</span>
    <span class="n">ind_plus</span> <span class="o">=</span> <span class="n">strfind</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">name_roi_in</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">delimiters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">vect_plus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind_plus</span><span class="p">))</span>
    <span class="n">ind_minus</span> <span class="o">=</span> <span class="n">strfind</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">name_roi_in</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">delimiters</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">vect_minus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind_minus</span><span class="p">))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">ind_plus</span><span class="p">,</span> <span class="n">ind_minus</span><span class="p">)))</span>
    <span class="n">vect_plus_minus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">vect_plus</span><span class="p">,</span> <span class="n">vect_minus</span><span class="p">))[</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">ind_plus</span><span class="p">,</span> <span class="n">ind_minus</span><span class="p">))[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">n_delim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">vect_plus_minus</span><span class="p">)</span>

    <span class="c1"># MAKING SURE &quot;+&quot; and &quot;-&quot; ARE NOT INSIDE A ROIname</span>
    <span class="n">ind_start</span> <span class="o">=</span> <span class="n">strfind</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">name_roi_in</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
    <span class="n">n_roi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_start</span><span class="p">)</span>
    <span class="n">ind_stop</span> <span class="o">=</span> <span class="n">strfind</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">name_roi_in</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>
    <span class="n">ind_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_delim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_delim</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_roi</span><span class="p">):</span>
             <span class="c1"># Thus not indise a ROI name</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ind_stop</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">-</span> <span class="n">ind</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">ind_start</span><span class="p">[</span><span class="n">r</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ind_keep</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">ind_keep</span><span class="p">]</span>
    <span class="n">vect_plus_minus</span> <span class="o">=</span> <span class="n">vect_plus_minus</span><span class="p">[</span><span class="n">ind_keep</span><span class="p">]</span>

    <span class="c1"># PARSING ROI NAMES</span>
    <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Excluding the &quot;{&quot; and &quot;}&quot; at the start and end of the ROIname</span>
        <span class="n">name_roi_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_roi_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_ind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="c1"># Excluding the &quot;{&quot; and &quot;}&quot; at the start and end of the ROIname</span>
        <span class="n">name_roi_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_roi_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">n_ind</span><span class="p">):</span>
            <span class="c1"># Excluding the &quot;{&quot; and &quot;}&quot; at the start and end of the ROIname</span>
            <span class="n">name_roi_out</span> <span class="o">+=</span> <span class="p">[</span><span class="n">name_roi_in</span><span class="p">[(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">):(</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)]]</span>
        <span class="n">name_roi_out</span> <span class="o">+=</span> <span class="p">[</span><span class="n">name_roi_in</span><span class="p">[(</span><span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">name_roi_out</span><span class="p">,</span> <span class="n">vect_plus_minus</span></div>
    
<div class="viewcode-block" id="roi_extract"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.roi_extract">[docs]</a><span class="k">def</span> <span class="nf">roi_extract</span><span class="p">(</span><span class="n">vol</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">roi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Replaces volume intensities outside the ROI with NaN.</span>

<span class="sd">    Args:</span>
<span class="sd">        vol (ndarray): Imaging data.</span>
<span class="sd">        roi (ndarray): ROI mask with values of 0&#39;s and 1&#39;s.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: Imaging data with original intensities in the ROI \</span>
<span class="sd">            and NaN for intensities outside the ROI.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vol_re</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
    <span class="n">vol_re</span><span class="p">[</span><span class="n">roi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">vol_re</span></div>

<div class="viewcode-block" id="get_polygon_mask"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.get_polygon_mask">[docs]</a><span class="k">def</span> <span class="nf">get_polygon_mask</span><span class="p">(</span><span class="n">roi_xyz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">spatial_ref</span><span class="p">:</span> <span class="n">imref3d</span><span class="p">,</span>
                     <span class="n">orientation</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Computes the indexes of the ROI (Region of interest) enclosing box</span>
<span class="sd">    in all dimensions.</span>

<span class="sd">    Args:</span>
<span class="sd">        roi_xyz (ndarray): array of (x,y,z) triplets defining a contour in the</span>
<span class="sd">                           Patient-Based Coordinate System extracted from DICOM RTstruct.</span>
<span class="sd">        spatial_ref (imref3d): imref3d object (same functionality of MATLAB imref3d class).</span>
<span class="sd">        orientation (str): Imaging data orientation (axial, sagittal or coronal).</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: 3D array of 1&#39;s and 0&#39;s defining the ROI mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># COMPUTING MASK</span>
    <span class="n">s_z</span> <span class="o">=</span> <span class="n">spatial_ref</span><span class="o">.</span><span class="n">ImageSize</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_z</span><span class="p">)</span>
    <span class="c1"># X,Y,Z in intrinsic image coordinates</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">worldToIntrinsic</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="n">spatial_ref</span><span class="p">,</span>
                               <span class="n">xWorld</span><span class="o">=</span><span class="n">roi_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                               <span class="n">yWorld</span><span class="o">=</span><span class="n">roi_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                               <span class="n">zWorld</span><span class="o">=</span><span class="n">roi_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;Axial&quot;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;Sagittal&quot;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;Coronal&quot;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Provided orientation is not one of </span><span class="se">\&quot;</span><span class="s2">Axial</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">Sagittal</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">Coronal</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="n">c</span><span class="p">])</span>  <span class="c1"># Must assign the points to one slice</span>
    <span class="n">closed_contours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">roi_xyz</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">x_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s_z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s_z</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x_q</span><span class="p">,</span> <span class="n">y_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_q</span><span class="p">,</span> <span class="n">y_q</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">c_c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">closed_contours</span><span class="p">)):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">roi_xyz</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">closed_contours</span><span class="p">[</span><span class="n">c_c</span><span class="p">]</span>
        <span class="c1"># Taking the mode, just in case. But normally, numel(unique(K(ind)))</span>
        <span class="c1"># should evaluate to 1, as closed contours are meant to be defined on</span>
        <span class="c1"># a given slice</span>
        <span class="n">select_slice</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">inpoly</span> <span class="o">=</span> <span class="n">inpolygon</span><span class="p">(</span><span class="n">x_q</span><span class="o">=</span><span class="n">x_q</span><span class="p">,</span> <span class="n">y_q</span><span class="o">=</span><span class="n">y_q</span><span class="p">,</span> <span class="n">x_v</span><span class="o">=</span><span class="n">points</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">a</span><span class="p">],</span> <span class="n">y_v</span><span class="o">=</span><span class="n">points</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
        <span class="n">roi_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">select_slice</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">roi_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">select_slice</span><span class="p">],</span> <span class="n">inpoly</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">roi_mask</span></div>

<div class="viewcode-block" id="voxel_to_spatial"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.voxel_to_spatial">[docs]</a><span class="k">def</span> <span class="nf">voxel_to_spatial</span><span class="p">(</span><span class="n">affine</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">voxel_pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert voxel position into spatial position.</span>

<span class="sd">    Args:</span>
<span class="sd">        affine (ndarray): Affine matrix.</span>
<span class="sd">        voxel_pos (list): A list that correspond to the location in voxel.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: A numpy array that correspond to the spatial position in mm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">translation</span> <span class="o">=</span> <span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">voxel_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">translation</span></div>

<div class="viewcode-block" id="spatial_to_voxel"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.spatial_to_voxel">[docs]</a><span class="k">def</span> <span class="nf">spatial_to_voxel</span><span class="p">(</span><span class="n">affine</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">spatial_pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert spatial position into voxel position</span>

<span class="sd">    Args:</span>
<span class="sd">        affine (ndarray): Affine matrix.</span>
<span class="sd">        spatial_pos (list): A list that correspond to the spatial location in mm.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: A numpy array that correspond to the position in the voxel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">translation</span> <span class="o">=</span> <span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">spatial_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">translation</span></div>

<div class="viewcode-block" id="crop_nifti_box"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.crop_nifti_box">[docs]</a><span class="k">def</span> <span class="nf">crop_nifti_box</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">Nifti1Image</span><span class="p">,</span>
                   <span class="n">roi</span><span class="p">:</span> <span class="n">Nifti1Image</span><span class="p">,</span>
                   <span class="n">crop_shape</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                   <span class="n">center</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Nifti1Image</span><span class="p">,</span>
                                                                       <span class="n">Nifti1Image</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Crops the Nifti image and ROI.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (Nifti1Image): Class for the file NIfTI1 format image that will be cropped.</span>
<span class="sd">        roi (Nifti1Image): Class for the file NIfTI1 format ROI that will be cropped.</span>
<span class="sd">        crop_shape (List[int]): The dimension of the region to crop in term of number of voxel.</span>
<span class="sd">        center (Union[Sequence[int], None]): A list that indicate the center of the cropping box</span>
<span class="sd">                                             in term of spatial position.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[Nifti1Image, Nifti1Image] : Two Nifti images of the cropped image and roi</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">crop_shape</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;All elements of crop_shape should be even number.&quot;</span>

    <span class="n">image_data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
    <span class="n">roi_data</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">crop_shape</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">roi_data</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

    <span class="n">center_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">center_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># If center_max and center_min are equal we add 1 to center_max to avoid trouble with crop.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">center_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">center_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">center_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">img_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

    <span class="c1"># Pad the image and the ROI if its necessary</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rad</span><span class="p">,</span> <span class="n">cent_min</span><span class="p">,</span> <span class="n">cent_max</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">center_min</span><span class="p">,</span> <span class="n">center_max</span><span class="p">,</span> <span class="n">img_shape</span><span class="p">):</span>
        <span class="n">padding</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cent_min</span> <span class="o">-</span> <span class="n">rad</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">cent_max</span> <span class="o">+</span> <span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">shape</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="n">image_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">padding</span><span class="p">]))</span>
    <span class="n">roi_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">roi_data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">padding</span><span class="p">]))</span>

    <span class="n">center_min</span> <span class="o">=</span> <span class="p">[</span><span class="n">center_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">center_max</span> <span class="o">=</span> <span class="p">[</span><span class="n">center_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

    <span class="c1"># Crop the image</span>
    <span class="n">image_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="n">center_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">center_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">center_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">roi_data</span> <span class="o">=</span> <span class="n">roi_data</span><span class="p">[</span><span class="n">center_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">center_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">center_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Update the image and the ROI</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Nifti1Image</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">roi</span> <span class="o">=</span> <span class="n">Nifti1Image</span><span class="p">(</span><span class="n">roi_data</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">roi</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">roi</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">roi</span></div>

<div class="viewcode-block" id="crop_box"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.crop_box">[docs]</a><span class="k">def</span> <span class="nf">crop_box</span><span class="p">(</span><span class="n">image_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">roi_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">crop_shape</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
             <span class="n">center</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Crops the imaging data and the ROI mask.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_data (ndarray): Imaging data that will be cropped.</span>
<span class="sd">        roi_data (ndarray): Mask data that will be cropped.</span>
<span class="sd">        crop_shape (List[int]): The dimension of the region to crop in term of number of voxel.</span>
<span class="sd">        center (Union[Sequence[int], None]): A list that indicate the center of the cropping box </span>
<span class="sd">                                             in term of spatial position.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[ndarray, ndarray] : Two numpy arrays of the cropped image and roi</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">crop_shape</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;All elements of crop_shape should be even number.&quot;</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">crop_shape</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">roi_data</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

    <span class="n">center_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">center_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># If center_max and center_min are equal we add 1 to center_max to avoid trouble with crop.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">center_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">center_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">center_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">img_shape</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Pad the image and the ROI if its necessary</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rad</span><span class="p">,</span> <span class="n">cent_min</span><span class="p">,</span> <span class="n">cent_max</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">center_min</span><span class="p">,</span> <span class="n">center_max</span><span class="p">,</span> <span class="n">img_shape</span><span class="p">):</span>
        <span class="n">padding</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cent_min</span> <span class="o">-</span> <span class="n">rad</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">cent_max</span> <span class="o">+</span> <span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">shape</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="n">image_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">padding</span><span class="p">]))</span>
    <span class="n">roi_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">roi_data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">padding</span><span class="p">]))</span>

    <span class="n">center_min</span> <span class="o">=</span> <span class="p">[</span><span class="n">center_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">center_max</span> <span class="o">=</span> <span class="p">[</span><span class="n">center_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

    <span class="c1"># Crop the image</span>
    <span class="n">image_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="n">center_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">center_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">center_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">roi_data</span> <span class="o">=</span> <span class="n">roi_data</span><span class="p">[</span><span class="n">center_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">center_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">center_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">center_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">image_data</span><span class="p">,</span> <span class="n">roi_data</span></div>

<div class="viewcode-block" id="compute_box"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.compute_box">[docs]</a><span class="k">def</span> <span class="nf">compute_box</span><span class="p">(</span><span class="n">vol</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">roi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">spatial_ref</span><span class="p">:</span> <span class="n">imref3d</span><span class="p">,</span>
                <span class="n">box_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                          <span class="n">imref3d</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Computes a new box around the ROI (Region of interest) from the original box</span>
<span class="sd">    and updates the volume and the ``spatial_ref``.</span>

<span class="sd">    Args:</span>
<span class="sd">        vol (ndarray): ROI mask with values of 0 and 1.</span>
<span class="sd">        roi (ndarray): ROI mask with values of 0 and 1.</span>
<span class="sd">        spatial_ref (imref3d): imref3d object (same functionality of MATLAB imref3d class).</span>
<span class="sd">        box_string (str): Specifies the new box to be computed</span>

<span class="sd">            * &#39;full&#39;: full imaging data as output.</span>
<span class="sd">            * &#39;box&#39;: computes the smallest bounding box.</span>
<span class="sd">            * Ex: &#39;box10&#39; means 10 voxels in all three dimensions are added to the smallest bounding box. The number \</span>
<span class="sd">                after &#39;box&#39; defines the number of voxels to add.</span>
<span class="sd">            * Ex: &#39;2box&#39; computes the smallest box and outputs double its \</span>
<span class="sd">                size. The number before &#39;box&#39; defines the multiplication in size.</span>
<span class="sd">    </span>
<span class="sd">    Returns: </span>
<span class="sd">        3-element tuple containing</span>

<span class="sd">        - ndarray: 3D array of imaging data defining the smallest box containing the ROI.</span>
<span class="sd">        - ndarray: 3D array of 1&#39;s and 0&#39;s defining the ROI in ROIbox.</span>
<span class="sd">        - imref3d: The associated imref3d object imaging data.</span>

<span class="sd">    Todo:</span>
<span class="sd">        * I would not recommend parsing different settings into a string. \</span>
<span class="sd">            Provide two or more parameters instead, and use None if one or more \</span>
<span class="sd">            are not used.</span>
<span class="sd">        * There is no else statement, so &quot;new_spatial_ref&quot; might be unset</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;box&quot;</span> <span class="ow">in</span> <span class="n">box_string</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">box_string</span> <span class="o">==</span> <span class="s2">&quot;box&quot;</span>
        <span class="n">box_bound</span> <span class="o">=</span> <span class="n">compute_bounding_box</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">roi</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">comp</span><span class="p">:</span>
            <span class="c1"># Always returns the first appearance</span>
            <span class="n">ind_box</span> <span class="o">=</span> <span class="n">box_string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;box&quot;</span><span class="p">)</span>
            <span class="c1"># Addition of a certain number of voxels in all dimensions</span>
            <span class="k">if</span> <span class="n">ind_box</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n_v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">box_string</span><span class="p">[(</span><span class="n">ind_box</span><span class="o">+</span><span class="mi">3</span><span class="p">):])</span>
                <span class="n">n_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">n_v</span><span class="p">,</span> <span class="n">n_v</span><span class="p">,</span> <span class="n">n_v</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Multiplication of the size of the box</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">box_string</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ind_box</span><span class="p">])</span>
                <span class="n">size_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">box_bound</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">new_box</span> <span class="o">=</span> <span class="n">size_box</span> <span class="o">*</span> <span class="n">factor</span>
                <span class="n">n_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">new_box</span> <span class="o">-</span> <span class="n">size_box</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="n">o_k</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">while</span> <span class="ow">not</span> <span class="n">o_k</span><span class="p">:</span>
                <span class="n">border</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">border</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">border</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">border</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">border</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">border</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">border</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">border</span> <span class="o">=</span> <span class="n">border</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">check1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">border</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">check2</span> <span class="o">=</span> <span class="n">border</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">check3</span> <span class="o">=</span> <span class="n">border</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">check4</span> <span class="o">=</span> <span class="n">border</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">check</span> <span class="o">=</span> <span class="n">check1</span> <span class="o">+</span> <span class="n">check2</span> <span class="o">+</span> <span class="n">check3</span> <span class="o">+</span> <span class="n">check4</span>

                <span class="k">if</span> <span class="n">check</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">o_k</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n_v</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n_v</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">o_k</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">n_v</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Will compute the smallest bounding box possible</span>
            <span class="n">n_v</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

        <span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">n_v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">box_bound</span> <span class="o">=</span> <span class="n">box_bound</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span><span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span><span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span><span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span><span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span><span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span><span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Resolution in mm, nothing has changed here in terms of resolution;</span>
        <span class="c1"># XYZ format here.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spatial_ref</span><span class="o">.</span><span class="n">PixelExtentInWorldX</span><span class="p">,</span>
                        <span class="n">spatial_ref</span><span class="o">.</span><span class="n">PixelExtentInWorldY</span><span class="p">,</span>
                        <span class="n">spatial_ref</span><span class="o">.</span><span class="n">PixelExtentInWorldZ</span><span class="p">])</span>

        <span class="c1"># IJK, as required by imref3d</span>
        <span class="n">size_box</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">box_bound</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">size_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">size_box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">size_box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_box</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_limit</span><span class="p">,</span> <span class="n">y_limit</span><span class="p">,</span> <span class="n">z_limit</span> <span class="o">=</span> <span class="n">intrinsicToWorld</span><span class="p">(</span><span class="n">spatial_ref</span><span class="p">,</span> 
                                                <span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                                <span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                                <span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">new_spatial_ref</span> <span class="o">=</span> <span class="n">imref3d</span><span class="p">(</span><span class="n">size_box</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># The limit is defined as the border of the first pixel</span>
        <span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">XWorldLimits</span> <span class="o">=</span> <span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">XWorldLimits</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">XWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">x_limit</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">YWorldLimits</span> <span class="o">=</span> <span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">YWorldLimits</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">YWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">y_limit</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">ZWorldLimits</span> <span class="o">=</span> <span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">ZWorldLimits</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">ZWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">z_limit</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">elif</span> <span class="s2">&quot;full&quot;</span> <span class="ow">in</span> <span class="n">box_string</span><span class="p">:</span>
        <span class="n">new_spatial_ref</span> <span class="o">=</span> <span class="n">spatial_ref</span>

    <span class="k">return</span> <span class="n">vol</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">new_spatial_ref</span></div>

<div class="viewcode-block" id="compute_bounding_box"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.compute_bounding_box">[docs]</a><span class="k">def</span> <span class="nf">compute_bounding_box</span><span class="p">(</span><span class="n">mask</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Computes the indexes of the ROI (Region of interest) enclosing box </span>
<span class="sd">    in all dimensions.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask (ndarray): ROI mask with values of 0 and 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: An array containing the indexes of the bounding box.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">iv</span><span class="p">,</span> <span class="n">jv</span><span class="p">,</span> <span class="n">kv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">box_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
    <span class="n">box_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>
    <span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">jv</span><span class="p">)</span>
    <span class="n">box_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">jv</span><span class="p">)</span>
    <span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">kv</span><span class="p">)</span>
    <span class="n">box_bound</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">kv</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">box_bound</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_roi"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.get_roi">[docs]</a><span class="k">def</span> <span class="nf">get_roi</span><span class="p">(</span><span class="n">MEDimage</span><span class="p">:</span> <span class="n">MEDimage</span><span class="p">,</span>
            <span class="n">name_roi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">box_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">interp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">image_volume_obj</span><span class="p">,</span>
                                   <span class="n">image_volume_obj</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Computes the ROI box (box containing the region of interest)</span>
<span class="sd">    and associated mask from MEDimage object.</span>

<span class="sd">    Args:</span>
<span class="sd">        MEDimage (MEDimage): The MEDimage class object.</span>
<span class="sd">        name_roi (str): name of the ROI since the a volume can have multuiple ROIs.</span>
<span class="sd">        box_string (str): Specifies the size if the box containing the ROI</span>

<span class="sd">                          - &#39;full&#39;: full imaging data as output.</span>
<span class="sd">                          - &#39;box&#39;: computes the smallest bounding box.</span>
<span class="sd">                          - Ex: &#39;box10&#39;: 10 voxels in all three dimensions are added to \</span>
<span class="sd">                            the smallest bounding box. The number after &#39;box&#39; defines the \</span>
<span class="sd">                            number of voxels to add.</span>
<span class="sd">                          - Ex: &#39;2box&#39;: Computes the smallest box and outputs double its \</span>
<span class="sd">                            size. The number before &#39;box&#39; defines the multiplication in size.</span>

<span class="sd">        interp (bool): True if we need to use an interpolation for box computation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        2-element tuple containing</span>

<span class="sd">        - image_volume_obj: 3D array of imaging data defining box containing the ROI. \</span>
<span class="sd">            vol.data is the 3D array, vol.spatialRef is its associated imref3d object.</span>
<span class="sd">        - image_volume_obj: 3D array of 1&#39;s and 0&#39;s defining the ROI. \</span>
<span class="sd">            roi.data is the 3D array, roi.spatialRef is its associated imref3d object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># PARSING OF ARGUMENTS</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">name_structure_set</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delimiters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;\+&quot;</span><span class="p">,</span> <span class="s2">&quot;\-&quot;</span><span class="p">]</span>
        <span class="n">n_contour_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">ROI</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span>

        <span class="n">name_roi</span><span class="p">,</span> <span class="n">vect_plus_minus</span> <span class="o">=</span> <span class="n">get_sep_roi_names</span><span class="p">(</span><span class="n">name_roi</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">)</span>
        <span class="n">contour_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name_roi</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">name_structure_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name_structure_set</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">name_structure_set</span><span class="p">:</span>
            <span class="n">name_structure_set</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_sep_roi_names</span><span class="p">(</span><span class="n">name_structure_set</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_roi</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_structure_set</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The numbers of defined ROI names and Structure Set names are not the same&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_roi</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_contour_data</span><span class="p">):</span>
                <span class="n">name_temp</span> <span class="o">=</span> <span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">ROI</span><span class="o">.</span><span class="n">get_roi_name</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name_temp</span> <span class="o">==</span> <span class="n">name_roi</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">name_structure_set</span><span class="p">:</span>
                        <span class="c1"># FOR DICOM + RTSTRUCT</span>
                        <span class="n">name_set_temp</span> <span class="o">=</span> <span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">ROI</span><span class="o">.</span><span class="n">get_name_set</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">name_set_temp</span> <span class="o">==</span> <span class="n">name_structure_set</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                            <span class="n">contour_number</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">contour_number</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="k">break</span>

        <span class="n">n_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">contour_number</span><span class="p">)</span>
        <span class="c1"># contour_string IS FOR EXAMPLE &#39;3&#39; or &#39;1-3+2&#39;</span>
        <span class="n">contour_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">contour_number</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_roi</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">vect_plus_minus</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
            <span class="k">elif</span> <span class="n">vect_plus_minus</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">contour_string</span> <span class="o">=</span> <span class="n">contour_string</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">+</span> \
                <span class="nb">str</span><span class="p">(</span><span class="n">contour_number</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">box_string</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span> <span class="ow">or</span> <span class="s2">&quot;box&quot;</span> <span class="ow">in</span> <span class="n">box_string</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The third argument must either be </span><span class="se">\&quot;</span><span class="s2">full</span><span class="se">\&quot;</span><span class="s2"> or contain the word </span><span class="se">\&quot;</span><span class="s2">box</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">interp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;If present (i.e. it is optional), the fourth argument must be bool&quot;</span><span class="p">)</span>

        <span class="n">contour_number</span><span class="p">,</span> <span class="n">operations</span> <span class="o">=</span> <span class="n">parse_contour_string</span><span class="p">(</span><span class="n">contour_string</span><span class="p">)</span>

        <span class="c1"># INTIALIZATIONS</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">contour_number</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">n_contour</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">contour_number</span> <span class="o">=</span> <span class="p">[</span><span class="n">contour_number</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_contour</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_number</span><span class="p">)</span>

        <span class="n">roi_mask_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">MEDimage</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PTscan&quot;</span><span class="p">,</span> <span class="s2">&quot;CTscan&quot;</span><span class="p">,</span> <span class="s2">&quot;MRscan&quot;</span><span class="p">,</span> <span class="s2">&quot;ADCscan&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown scan type.&quot;</span><span class="p">)</span>

        <span class="n">spatial_ref</span> <span class="o">=</span> <span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">spatialRef</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># COMPUTING ALL MASKS</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">n_contour</span><span class="p">):</span>
            <span class="n">contour</span> <span class="o">=</span> <span class="n">contour_number</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="c1"># GETTING THE XYZ POINTS FROM MEDimage</span>
            <span class="n">roi_xyz</span> <span class="o">=</span> <span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">ROI</span><span class="o">.</span><span class="n">get_indexes</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">contour</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># APPLYING ROTATION TO XYZ POINTS (if necessary --&gt; MRscan)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="s1">&#39;scanRot&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">scanRot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">roi_xyz</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                    <span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">scanRot</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">roi_xyz</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]))</span>

            <span class="c1"># APPLYING TRANSLATION IF SIMULATION STRUCTURE AS INPUT</span>
            <span class="c1"># (software STAMP utility)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="s1">&#39;transScanToModel&#39;</span><span class="p">):</span>
                <span class="n">translation</span> <span class="o">=</span> <span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">transScanToModel</span>
                <span class="n">roi_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">translation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">roi_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">roi_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">translation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># COMPUTING THE ROI MASK</span>
            <span class="c1"># Problem here in compute_roi.m: If the volume is a full-body CT and the</span>
            <span class="c1"># slice interpolation process occurs, a lot of RAM will be used.</span>
            <span class="c1"># One solution could be to a priori compute the bounding box before</span>
            <span class="c1"># computing the ROI (using XYZ points). But we still want the user to</span>
            <span class="c1"># be able to fully use the &quot;box&quot; argument, so we are fourr...TO SOLVE!</span>
            <span class="n">roi_mask_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">compute_roi</span><span class="p">(</span><span class="n">roi_xyz</span><span class="o">=</span><span class="n">roi_xyz</span><span class="p">,</span> 
                                        <span class="n">spatial_ref</span><span class="o">=</span><span class="n">spatial_ref</span><span class="p">,</span>
                                        <span class="n">orientation</span><span class="o">=</span><span class="n">MEDimage</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">orientation</span><span class="p">,</span>
                                        <span class="n">scan_type</span><span class="o">=</span><span class="n">MEDimage</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                                        <span class="n">interp</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)]</span>

        <span class="c1"># APPLYING OPERATIONS ON ALL MASKS</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">roi_mask_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">n_contour</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">operations</span><span class="p">[</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
                <span class="n">roi</span> <span class="o">+=</span> <span class="n">roi_mask_list</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">operations</span><span class="p">[</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">roi</span> <span class="o">-=</span> <span class="n">roi_mask_list</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown operation on ROI.&quot;</span><span class="p">)</span>

            <span class="n">roi</span><span class="p">[</span><span class="n">roi</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">roi</span><span class="p">[</span><span class="n">roi</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># COMPUTING THE BOUNDING BOX</span>
        <span class="n">vol</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">new_spatial_ref</span> <span class="o">=</span> <span class="n">compute_box</span><span class="p">(</span><span class="n">vol</span><span class="o">=</span><span class="n">vol</span><span class="p">,</span> 
                                            <span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span>
                                            <span class="n">spatial_ref</span><span class="o">=</span><span class="n">spatial_ref</span><span class="p">,</span>
                                            <span class="n">box_string</span><span class="o">=</span><span class="n">box_string</span><span class="p">)</span>

        <span class="c1"># ARRANGE OUTPUT</span>
        <span class="n">vol_obj</span> <span class="o">=</span> <span class="n">image_volume_obj</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">vol</span><span class="p">,</span> <span class="n">spatial_ref</span><span class="o">=</span><span class="n">new_spatial_ref</span><span class="p">)</span>
        <span class="n">roi_obj</span> <span class="o">=</span> <span class="n">image_volume_obj</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span> <span class="n">spatial_ref</span><span class="o">=</span><span class="n">new_spatial_ref</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> PROBLEM WITH PRE-PROCESSING OF FEATURES IN get_roi(): </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">MEDimage</span><span class="o">.</span><span class="n">Params</span><span class="p">[</span><span class="s1">&#39;radiomics&#39;</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{(</span><span class="s1">&#39;scale&#39;</span><span class="o">+</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">MEDimage</span><span class="o">.</span><span class="n">Params</span><span class="p">[</span><span class="s1">&#39;scaleNonText&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;dot&#39;</span><span class="p">)):</span> <span class="s1">&#39;ERROR_PROCESSING&#39;</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">vol_obj</span><span class="p">,</span> <span class="n">roi_obj</span></div>

<div class="viewcode-block" id="compute_roi"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.compute_roi">[docs]</a><span class="k">def</span> <span class="nf">compute_roi</span><span class="p">(</span><span class="n">roi_xyz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">spatial_ref</span><span class="p">:</span> <span class="n">imref3d</span><span class="p">,</span>
                <span class="n">orientation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">scan_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">interp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Computes the ROI (Region of interest) mask using the XYZ coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        roi_xyz (ndarray): array of (x,y,z) triplets defining a contour in the Patient-Based</span>
<span class="sd">                           Coordinate System extracted from DICOM RTstruct.</span>
<span class="sd">        spatial_ref (imref3d): imref3d object (same functionality of MATLAB imref3d class).</span>
<span class="sd">        orientation (str): Imaging data ``orientation`` (axial, sagittal or coronal).</span>
<span class="sd">        scan_type (str): Imaging modality (MRscan, CTscan...).</span>
<span class="sd">        interp (bool): Specifies if we need to use an interpolation \</span>
<span class="sd">            process prior to :func:`get_polygon_mask()` in the slice axis direction.</span>

<span class="sd">            - True: Interpolation is performed in the slice axis dimensions. To be further \</span>
<span class="sd">                tested, thus please use with caution (True is safer).</span>
<span class="sd">            - False (default): No interpolation. This can definitely be safe \</span>
<span class="sd">                when the RTstruct has been saved specifically for the volume of \</span>
<span class="sd">                interest.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        ndarray: 3D array of 1&#39;s and 0&#39;s defining the ROI mask.</span>

<span class="sd">    Todo:</span>
<span class="sd">        - Using interpolation: this part needs to be further tested.</span>
<span class="sd">        - Consider changing to &#39;if statement&#39;. Changing ``interp`` variable here will change the ``interp`` variable everywhere</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">while</span> <span class="n">interp</span><span class="p">:</span>
        <span class="c1"># Initialization</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;Axial&quot;</span><span class="p">:</span>
            <span class="n">dim_ijk</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">dim_xyz</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span>
            <span class="c1"># Only the resolution in &#39;Z&#39; will be changed</span>
            <span class="n">res_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spatial_ref</span><span class="o">.</span><span class="n">PixelExtentInWorldX</span><span class="p">,</span>
                               <span class="n">spatial_ref</span><span class="o">.</span><span class="n">PixelExtentInWorldY</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;Sagittal&quot;</span><span class="p">:</span>
            <span class="n">dim_ijk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dim_xyz</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span>
            <span class="c1"># Only the resolution in &#39;Y&#39; will be changed</span>
            <span class="n">res_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spatial_ref</span><span class="o">.</span><span class="n">PixelExtentInWorldX</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                               <span class="n">spatial_ref</span><span class="o">.</span><span class="n">PixelExtentInWorldZ</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;Coronal&quot;</span><span class="p">:</span>
            <span class="n">dim_ijk</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">dim_xyz</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span>
            <span class="c1"># Only the resolution in &#39;X&#39; will be changed</span>
            <span class="n">res_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">spatial_ref</span><span class="o">.</span><span class="n">PixelExtentInWorldY</span><span class="p">,</span>
                               <span class="n">spatial_ref</span><span class="o">.</span><span class="n">PixelExtentInWorldZ</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Provided orientation is not one of </span><span class="se">\&quot;</span><span class="s2">Axial</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">Sagittal</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">Coronal</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Creating new imref3d object for sample points (with slice dimension</span>
        <span class="c1"># similar to original volume</span>
        <span class="c1"># where RTstruct was created)</span>
        <span class="c1"># Slice spacing in mm</span>
        <span class="n">slice_spacing</span> <span class="o">=</span> <span class="n">find_spacing</span><span class="p">(</span>
            <span class="n">roi_xyz</span><span class="p">[:,</span> <span class="n">dim_ijk</span><span class="p">],</span> <span class="n">scan_type</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Only one slice found in the function &quot;find_spacing&quot; on the above line.</span>
        <span class="c1"># We thus must set &quot;slice_spacing&quot; to the slice spacing of the queried</span>
        <span class="c1"># volume, and no interpolation will be performed.</span>
        <span class="k">if</span> <span class="n">slice_spacing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slice_spacing</span> <span class="o">=</span> <span class="n">spatial_ref</span><span class="o">.</span><span class="n">PixelExtendInWorld</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">direction</span><span class="p">)</span>

        <span class="n">new_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">spatial_ref</span><span class="o">.</span><span class="n">ImageExtentInWorld</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="n">direction</span><span class="p">)</span> <span class="o">/</span> <span class="n">slice_spacing</span><span class="p">)</span>
        <span class="n">res_xyz</span><span class="p">[</span><span class="n">dim_xyz</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_spacing</span>
        <span class="n">s_z</span> <span class="o">=</span> <span class="n">spatial_ref</span><span class="o">.</span><span class="n">ImageSize</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">s_z</span><span class="p">[</span><span class="n">dim_ijk</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_size</span>

        <span class="n">xWorldLimits</span> <span class="o">=</span> <span class="n">spatial_ref</span><span class="o">.</span><span class="n">XWorldLimits</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">yWorldLimits</span> <span class="o">=</span> <span class="n">spatial_ref</span><span class="o">.</span><span class="n">YWorldLimits</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">zWorldLimits</span> <span class="o">=</span> <span class="n">spatial_ref</span><span class="o">.</span><span class="n">ZWorldLimits</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">new_spatial_ref</span> <span class="o">=</span> <span class="n">imref3d</span><span class="p">(</span><span class="n">imageSize</span><span class="o">=</span><span class="n">s_z</span><span class="p">,</span> 
                                <span class="n">pixelExtentInWorldX</span><span class="o">=</span><span class="n">res_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">pixelExtentInWorldY</span><span class="o">=</span><span class="n">res_xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">pixelExtentInWorldZ</span><span class="o">=</span><span class="n">res_xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                <span class="n">xWorldLimits</span><span class="o">=</span><span class="n">xWorldLimits</span><span class="p">,</span>
                                <span class="n">yWorldLimits</span><span class="o">=</span><span class="n">yWorldLimits</span><span class="p">,</span>
                                <span class="n">zWorldLimits</span><span class="o">=</span><span class="n">zWorldLimits</span><span class="p">)</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">ImageExtentInWorld</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">direction</span><span class="p">)</span> <span class="o">-</span>
                <span class="n">spatial_ref</span><span class="o">.</span><span class="n">ImageExtentInWorld</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">direction</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="c1"># Sampled and queried volume are considered &quot;different&quot;.</span>
            <span class="n">new_limit</span> <span class="o">=</span> <span class="n">spatial_ref</span><span class="o">.</span><span class="n">WorldLimits</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">direction</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">diff</span> <span class="o">/</span> <span class="mf">2.0</span>

            <span class="c1"># Sampled volume is now centered on queried volume.</span>
            <span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">WorldLimits</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span> <span class="n">newValue</span><span class="o">=</span><span class="p">(</span><span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">WorldLimits</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">direction</span><span class="p">)</span> <span class="o">-</span>
                                                                <span class="p">(</span><span class="n">new_spatial_ref</span><span class="o">.</span><span class="n">WorldLimits</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">direction</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> 
                                                                 <span class="n">new_limit</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Less than a 0.01 mm, sampled and queried volume are considered</span>
            <span class="c1"># to be the same. At this point,</span>
            <span class="c1"># spatial_ref and new_spatial_ref may have differed due to data</span>
            <span class="c1"># manipulation, so we simply compute</span>
            <span class="c1"># the ROI mask with spatial_ref (i.e. simply using &quot;poly2mask.m&quot;),</span>
            <span class="c1"># without performing interpolation.</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>  <span class="c1"># Getting out of the &quot;while&quot; statement</span>

        <span class="n">V</span> <span class="o">=</span> <span class="n">get_polygon_mask</span><span class="p">(</span><span class="n">roi_xyz</span><span class="p">,</span> <span class="n">new_spatial_ref</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>

        <span class="c1"># Getting query points (x_q,y_q,z_q) of output roi_mask</span>
        <span class="n">sz_q</span> <span class="o">=</span> <span class="n">spatial_ref</span><span class="o">.</span><span class="n">ImageSize</span>
        <span class="n">x_qi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sz_q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y_qi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sz_q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">z_qi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sz_q</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">x_qi</span><span class="p">,</span> <span class="n">y_qi</span><span class="p">,</span> <span class="n">z_qi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_qi</span><span class="p">,</span> <span class="n">y_qi</span><span class="p">,</span> <span class="n">z_qi</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

        <span class="c1"># Getting queried mask</span>
        <span class="n">v_q</span> <span class="o">=</span> <span class="n">interp3</span><span class="p">(</span><span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">x_q</span><span class="o">=</span><span class="n">x_qi</span><span class="p">,</span> <span class="n">y_q</span><span class="o">=</span><span class="n">y_qi</span><span class="p">,</span> <span class="n">z_q</span><span class="o">=</span><span class="n">z_qi</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">)</span>
        <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">v_q</span>
        <span class="n">roi_mask</span><span class="p">[</span><span class="n">v_q</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">roi_mask</span><span class="p">[</span><span class="n">v_q</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Getting out of the &quot;while&quot; statement</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># SIMPLY USING &quot;poly2mask.m&quot; or &quot;inpolygon.m&quot;. &quot;inpolygon.m&quot; is slower, but</span>
    <span class="c1"># apparently more accurate.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">interp</span><span class="p">:</span>
        <span class="c1"># Using the inpolygon.m function. To be further tested.</span>
        <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">get_polygon_mask</span><span class="p">(</span><span class="n">roi_xyz</span><span class="p">,</span> <span class="n">spatial_ref</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">roi_mask</span></div>

<div class="viewcode-block" id="find_spacing"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.segmentation.find_spacing">[docs]</a><span class="k">def</span> <span class="nf">find_spacing</span><span class="p">(</span><span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">scan_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Finds the slice spacing in mm.</span>

<span class="sd">    Note:</span>
<span class="sd">        This function works for points from at least 2 slices. If only</span>
<span class="sd">        one slice is present, the function returns a None.</span>

<span class="sd">    Args:</span>
<span class="sd">        points (ndarray): Array of (x,y,z) triplets defining a contour in the</span>
<span class="sd">            Patient-Based Coordinate System extracted from DICOM RTstruct.</span>
<span class="sd">        scan_type (str): Imaging modality (MRscan, CTscan...) </span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Slice spacing in mm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">decim_keep</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># We keep at most 4 decimals to find the slice spacing.</span>

    <span class="c1"># Rounding to the nearest 0.1 mm, MRI is more problematic due to arbitrary</span>
    <span class="c1"># orientations allowed for imaging volumes.</span>
    <span class="k">if</span> <span class="n">scan_type</span> <span class="o">==</span> <span class="s2">&quot;MRscan&quot;</span><span class="p">:</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">n_slices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_slices</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">slices</span><span class="p">))</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">decim_keep</span><span class="p">)</span>
    <span class="n">slice_spacing</span><span class="p">,</span> <span class="n">nOcc</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nOcc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">slice_spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">slice_spacing</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MEDimage.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>